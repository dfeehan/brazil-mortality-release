


jab_age_ests <- jab_asdr_ests %>%
  select(-starts_with('se')) %>%
  ungroup() %>%
  # to summarize across all rows in the tibble
  group_by(method, agegp10) %>%
  # overall estimated variance in mse diff is average of city-specific 
  # variance estimates, which is (1/27)^2 times the sum of 
  # the city-specific variances
  # (we need (1/27)^2 because we're pulling a constant out of the
  #  variance -- see the appendix notes)
  summarize(across(starts_with('var'), 
                   ~ ((1/NUM_GEO_UNITS)^2)*sum(.x) ,
                   .names = "{.col}")) %>%
  mutate(across(starts_with('var_'), list(se=sqrt), .names="{.fn}_{.col}")) %>%
  rename_with(~ str_replace(.x, '_var', ''), starts_with('se_var')) %>%
  left_join(jab_age_diff_ests)
  
Tibbles
=======



LEFT OFF HERE: I think the results we need are in

- asdr_properties
- asdr_geo_properties
- asdr_agesex_properties
- asdr_tot_properties

and

- prob_properties
- prob_geo_properties
- prob_tot_properties





jab_asdr_ests -> uncertainty in asdr ests for indiv methods + diff
jab_prob_ests

asdr_properties -> cell (city/age/sex) point estimates, diffs, + JAB uncertainties
prob_properties
=> TODO - add std err?

jab_geo_asdr_ests -> uncertainty in asdr ests for indiv methods + diff at geo level
jab_geo_prob_ests

asdr_geo_properties
porb_geo_properties

asdr_agesex_properties
(nothing analogous for probs here)



jab_asdr_diff_ests -> uncertainty in asdr diffs at city/age/sex level
jab_geo_diff_ests -> uncertainty in asdr indiv methods + diffs at city level
jab_age_diff_ests -> uncertainty in asdr diffs at age level
jab_age_ests -> uncertainty in indiv methods at age level
jab_tot_diff_ests -> uncertainty in asdr indiv methods + diffs at total level
  
asdr_properties -> estimates + uncertainty for indiv estimates at city/age/sex level 
asdr_diff_properties -> estimates + uncertainty for diffs at city/age/sex level  
  
asdr_geo_diff_properties -> estimates + uncertainty for diffs at geo level
asdr_geo_properties -> estimates + uncertainty for indivd methods at geo level

asdr_age_diff_properties -> estimates + uncertainty for diffs + indiv methods at age level

asdr_tot_diff_properties -> estimates + uncertainty for diffs + indiv methods at total level
  -> TODO need to add indiv methods here
  
WANT

X asdr_properties -> estimates + uncertainty for indiv ests + diffs at city/age/sex level

asdr_geo_properties ->estimates + uncertainty for indiv ests + diffs at city level
  => TODO need uncertainty around bias/variance (currently have RMSE)
  
asdr_age_properties ->estimates + uncertainty for indiv ests + diffs at age level

asdr_tot_properties ->estimates + uncertainty for indiv ests + diffs at tot level


LONG FORM

method
- sibling
- network
- diff_n_minus_s


need overall

ASDR MARE diff and SE
ASDR RMSE diff and SE
Prob MARE diff and SE
Prob RMSE diff and SE


For errors, need:

diff_nminuss_mean,
ymin=diff_nminuss_ci_low,
ymax=diff_nminuss_ci_high,

for each city/region/national and vr/adjusted vr


columns:

loss
qty
geo

REAL COLS


boot_idx
err.n.minus.s
err.n
err.s
loss
qty
comparison_name (eg 'vr_comparison')
geo_name


### Error difference pointrange figure

The city asdr boot estimates have the average asdr error across 27 cities for each bootstrap rep (as well as results for prob)
The region asdr boot estimates have the average region asdr error across 5 regions for each bootstrap rep (as well as results for prob)
et cetera

```{r}
errs_cv <- read_csv(file.path(vr_city_dir, 'err_diffs_jab.csv'))
errs_rv <- read_csv(file.path(vr_region_dir, 'err_diffs_jab.csv'))
errs_nv <- read_csv(file.path(vr_national_dir, 'err_diffs_jab.csv'))
#errs_cv <- read_csv(file.path(vr_city_dir, 'err_diffs_boot.csv'))
#errs_rv <- read_csv(file.path(vr_region_dir, 'err_diffs_boot.csv'))
#errs_nv <- read_csv(file.path(vr_national_dir, 'err_diffs_boot.csv'))

errs_ca <- read_csv(file.path(vradj_city_dir, 'err_diffs_jab.csv'))
errs_ra <- read_csv(file.path(vradj_region_dir, 'err_diffs_jab.csv'))
errs_na <- read_csv(file.path(vradj_national_dir, 'err_diffs_jab.csv'))
#errs_ca <- read_csv(file.path(vradj_city_dir, 'err_diffs_boot.csv'))
#errs_ra <- read_csv(file.path(vradj_region_dir, 'err_diffs_boot.csv'))
#errs_na <- read_csv(file.path(vradj_national_dir, 'err_diffs_boot.csv'))
```

### Err diffs boot

TODO - this is the part that I think we need to change to reflect the
jackknife-after-bootstrap results

```{r}
err_diffs_isum <- bind_rows(errs_cv,
                            errs_rv,
                            errs_nv,
                            errs_ca,
                            errs_ra,
                            errs_na)

err_diffs_summ <- err_diffs_boot %>%
  group_by(comparison_name, geo_name, qty, loss) %>%
  summarize(diff_nminuss_mean = mean(err.n.minus.s),
            diff_nminuss_ci_low = quantile(err.n.minus.s, .025),
            diff_nminuss_ci_high = quantile(err.n.minus.s, .975),
            network_err = mean(err.n),
            network_err_ci_low = quantile(err.n, .025),
            network_err_ci_high = quantile(err.n, .975),
            network_err_sd = sd(err.n),
            network_err_ci_width = quantile(err.n, .975) - quantile(err.n, .025),
            sibling_err = mean(err.s),
            sibling_err_ci_low = quantile(err.s, .025),
            sibling_err_ci_high = quantile(err.s, .975),
            sibling_err_sd = sd(err.s),
            sibling_err_ci_width = quantile(err.s, .975) - quantile(err.s, .025),
            .groups='drop')

err_diffs_summ
```



```{r}
recode_loss <- c('mare'='MARE', 'mse'='MSE', 'rmse'='RMSE')
recode_qty <- c('asdr'='Age-specifc\ndeath rates', 'prob'='Probability of\ndying at\nadult ages')
recode_geo <- c('city'='City-level\nestimates', 
                'region'='Pooled\nregion-level\nestimates', 
                'national'='Pooled\nnational-level\nestimates')

scale_linetype_values <- setNames(c("solid", "dashed", "dashed"),
                                  paste(recode_geo))

scale_shape_values <- setNames(c(19, 1, 1),
                               paste(recode_geo))

annrelsize <- 3 

mare_prob_annheight <- 0.15
mare_asdr_annheight <- .22

mse_prob_annheight <- 0.0035
mse_asdr_annheight <- 8 

rmse_prob_annheight <- .025 
rmse_asdr_annheight <- 1 

#shade_rect_color <- 'lightgrey'
shade_rect_color <- '#EEEEEE'
shade_rect_alpha <- .05

for_pr_plot_base <- err_diffs_summ %>%
  mutate(loss = dplyr::recode(loss, !!!recode_loss)) %>%
  mutate(qty= dplyr::recode(qty, !!!recode_qty)) %>%
  mutate(geo_name= dplyr::recode_factor(geo_name, !!!recode_geo))

for_pr_plot <- for_pr_plot_base %>%
  filter(comparison_name == 'vr_comparison')

for_pr_vrsens_plot <- for_pr_plot_base %>%
  filter(comparison_name == 'vr_adj_comparison')

make_pr_plot <- function(for_pr_df) {
    
  pr_asdr_mare <- 
    for_pr_df %>%
    filter(loss == 'MARE', qty==recode_qty['asdr']) %>%
    ggplot(.) +
    geom_hline(aes(yintercept = 0), color='darkgrey') +
    geom_pointrange(aes(x=geo_name,
                        y=diff_nminuss_mean,
                        ymin=diff_nminuss_ci_low,
                        ymax=diff_nminuss_ci_high,
                        shape = geo_name,
                        linetype = geo_name)) +
    theme_bw() +
    geom_rect(aes(xmin=1.5,
                  xmax=Inf,
                  ymin=-Inf,
                  ymax=Inf),
              color=shade_rect_color,
              alpha=shade_rect_alpha) +
    #theme_minimal() +
    ylab("Network MARE- Sibling MARE") +
    xlab("") +
    annotate(geom='text', 
             label="Sibling is better ->", 
             y=mare_asdr_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    annotate(geom='text', 
             label="<- Network is better ", 
             y=-mare_asdr_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    scale_y_continuous(labels = scales::percent_format(),
                       limits = c(-.45, .45)) +
    scale_linetype_manual(values=scale_linetype_values, guide = "none") +
    scale_shape_manual(values=scale_shape_values, guide = "none") +
    NULL
  
  pr_prob_mare <- 
    for_pr_df %>%
    filter(loss == 'MARE', qty==recode_qty['prob']) %>%
    ggplot(.) +
    geom_hline(aes(yintercept = 0), color='darkgrey') +
    geom_pointrange(aes(x=geo_name,
                        y=diff_nminuss_mean,
                        ymin=diff_nminuss_ci_low,
                        ymax=diff_nminuss_ci_high,
                        shape = geo_name,
                        linetype=geo_name)) +
    theme_bw() +
    geom_rect(aes(xmin=1.5,
                  xmax=Inf,
                  ymin=-Inf,
                  ymax=Inf),
              color=shade_rect_color,
              alpha=shade_rect_alpha) +
    #theme_minimal() +
    ylab("Network MARE- Sibling MARE") +
    xlab("") +
    annotate(geom='text', 
             label="Sibling is better ->", 
             y=mare_prob_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    annotate(geom='text', 
             label="<- Network is better ", 
             y=-mare_prob_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    scale_y_continuous(labels = scales::percent_format(),
                       limits=c(-.3, .3)) +
    scale_shape_manual(values=scale_shape_values, guide = "none") +
    scale_linetype_manual(values=scale_linetype_values, guide = "none") +
    NULL
    
  pr_prob_mse <- 
    for_pr_df %>%
    filter(loss == 'MSE', qty==recode_qty['prob']) %>%
    ggplot(.) +
    geom_hline(aes(yintercept = 0), color='darkgrey') +
    geom_pointrange(aes(x=geo_name,
                        y=diff_nminuss_mean,
                        ymin=diff_nminuss_ci_low,
                        ymax=diff_nminuss_ci_high,
                        shape = geo_name,
                        linetype=geo_name)) +
    theme_bw() +
    geom_rect(aes(xmin=1.5,
                  xmax=Inf,
                  ymin=-Inf,
                  ymax=Inf),
              color=shade_rect_color,
              alpha=shade_rect_alpha) +
    #theme_minimal() +
    ylab("Network MSE - Sibling MSE") +
    xlab("") +
    annotate(geom='text', 
             label="Sibling is better ->", 
             y=mse_prob_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    annotate(geom='text', 
             label="<- Network is better ", 
             y=-mse_prob_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    scale_y_continuous(limits=c(-.008, .008)) +
    scale_shape_manual(values=scale_shape_values, guide = "none") +
    scale_linetype_manual(values=scale_linetype_values, guide = "none") +
    NULL
    
  pr_asdr_mse <- 
    for_pr_df %>%
    filter(loss == 'MSE', qty==recode_qty['asdr']) %>%
    ggplot(.) +
    geom_hline(aes(yintercept = 0), color='darkgrey') +
    geom_pointrange(aes(x=geo_name,
                        y=diff_nminuss_mean,
                        ymin=diff_nminuss_ci_low,
                        ymax=diff_nminuss_ci_high,
                        shape = geo_name,
                        linetype=geo_name)) +
    theme_bw() +
    geom_rect(aes(xmin=1.5,
                  xmax=Inf,
                  ymin=-Inf,
                  ymax=Inf),
              color=shade_rect_color,
              alpha=shade_rect_alpha) +
    #theme_minimal() +
    ylab("Network MSE - Sibling MSE") +
    xlab("") +
    annotate(geom='text', 
             label="Sibling is better ->", 
             y=mse_asdr_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    annotate(geom='text', 
             label="<- Network is better ", 
             y=-mse_asdr_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    scale_y_continuous(limits=c(-15, 15)) +
    scale_shape_manual(values=scale_shape_values, guide = "none") +
    scale_linetype_manual(values=scale_linetype_values, guide = "none") +
    NULL
  
  pr_prob_rmse <- 
    for_pr_df %>%
    filter(loss == 'RMSE', qty==recode_qty['prob']) %>%
    ggplot(.) +
    geom_hline(aes(yintercept = 0), color='darkgrey') +
    geom_pointrange(aes(x=geo_name,
                        y=diff_nminuss_mean,
                        ymin=diff_nminuss_ci_low,
                        ymax=diff_nminuss_ci_high,
                        shape = geo_name,
                        linetype=geo_name)) +
    theme_bw() +
    geom_rect(aes(xmin=1.5,
                  xmax=Inf,
                  ymin=-Inf,
                  ymax=Inf),
              color=shade_rect_color,
              alpha=shade_rect_alpha) +
    #theme_minimal() +
    ylab("Network RMSE - Sibling RMSE") +
    xlab("") +
    annotate(geom='text', 
             label="Sibling is better ->", 
             y=rmse_prob_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    annotate(geom='text', 
             label="<- Network is better ", 
             y=-rmse_prob_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    scale_y_continuous(limits=c(-.05, .05)) +
    scale_linetype_manual(values=scale_linetype_values, guide = "none") +
    scale_shape_manual(values=scale_shape_values, guide = "none") +
    NULL
  
  pr_asdr_rmse <- 
    for_pr_df %>%
    filter(loss == 'RMSE', qty==recode_qty['asdr']) %>%
    ggplot(.) +
    geom_hline(aes(yintercept = 0), color='darkgrey') +
    geom_pointrange(aes(x=geo_name,
                        y=diff_nminuss_mean,
                        ymin=diff_nminuss_ci_low,
                        ymax=diff_nminuss_ci_high,
                        shape = geo_name,
                        linetype=geo_name)) +
    theme_bw() +
    geom_rect(aes(xmin=1.5,
                  xmax=Inf,
                  ymin=-Inf,
                  ymax=Inf),
              color=shade_rect_color,
              alpha=shade_rect_alpha) +
    #theme_minimal() +
    ylab("Network RMSE - Sibling RMSE") +
    xlab("") +
    annotate(geom='text', 
             label="Sibling is better ->", 
             y=rmse_asdr_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    annotate(geom='text', 
             label="<- Network is better ", 
             y=-rmse_asdr_annheight, 
             x=0.5, 
             size=rel(annrelsize),
             color='red', 
             angle=90) +
    scale_y_continuous(limits=c(-2, 2)) +
    scale_shape_manual(values=scale_shape_values, guide = "none") +
    scale_linetype_manual(values=scale_linetype_values, guide = "none") +
    NULL
    
  #pr_asdr_mare
  #pr_prob_mare
  #pr_prob_mse
  #pr_asdr_mse
  #pr_prob_rmse
  #pr_asdr_rmse
  
  meta_layout <- "
  #cccddd
  aeeefff
  bggghhh
  "
  
  row1_title <- ggplot() + annotate(geom='text', 
                                    x=1,y=1, 
                                    label='bold(underline(ASDR))', 
                                    angle=90,
                                    parse=TRUE) +  theme_void()
  row2_title <- ggplot() + annotate(geom='text', 
                                    x=1,y=1, 
                                    label='bold(underline(Probability~of~Death))', 
                                    angle=90,
                                    parse=TRUE) + theme_void()
  col1_title <- ggplot() + annotate(geom='text', 
                                    x=1,y=1, 
                                    label='bold(underline(MARE))',
                                    parse=TRUE) + theme_void()
  col2_title <- ggplot() + annotate(geom='text', 
                                    x=1,y=1, 
                                    #label='bold(underline(MSE))',
                                    label='bold(underline(RMSE))',
                                    parse=TRUE) + theme_void()
  
  plotlist <- list(a=row1_title,
                   b=row2_title,
                   c=col1_title,
                   d=col2_title,
                   e=pr_asdr_mare,
                   #f=pr_asdr_mse,
                   f=pr_asdr_rmse,
                   g=pr_prob_mare,
                   h=pr_prob_rmse)
                   #h=pr_prob_mse)
    
  final_plot <- wrap_plots(
       plotlist,
       guides='collect',
       design=meta_layout,
       widths=c(2,10,10),
       heights=c(2,10,10))
    
  
  return(final_plot)
}

final_err_compare <- make_pr_plot(for_pr_plot)
  
saveRDS(final_err_compare, file.path(out_dir, "err_compare_all.rds"))
fec.size <- 8 
ggsave(filename=file.path(out_dir, "err_compare_all.pdf"),
       plot=final_err_compare,
       height=fec.size,
       width=fec.size)
ggsave(filename=file.path(out_dir, "err_compare_all.png"),
       plot=final_err_compare,
       height=fec.size,
       width=fec.size)

tmp_rmse <- for_pr_plot %>% filter(qty=="Age-specifc\ndeath rates", 
                                   loss=="RMSE", 
                                   geo_name == "City-level\nestimates")
tmp_mare <- for_pr_plot %>% filter(qty=="Age-specifc\ndeath rates", 
                                   loss=="MARE", 
                                   geo_name == "City-level\nestimates")

glue::glue("
           Average network RMSE: {tmp_rmse$network_err}
           Average sibling RMSE: {tmp_rmse$sibling_err}
           On average, network estimates were about {tmp_rmse$diff_nminuss_mean} RMSE units better than sibling estimates.  
           This difference is {tmp_mare$diff_nminuss_mean} percent using MARE.
           
           ")

final_err_compare
```


Simple barplot with RMSE comparison at city level

```{r}
barplot_asdr_rmse_df <- 
    for_pr_plot %>%
    filter(loss == 'RMSE', str_detect(geo_name, 'City-level'), qty==recode_qty['asdr']) %>%
  select(comparison_name, geo_name, qty, loss, network_err, sibling_err) %>%
  pivot_longer(cols=c('network_err', 'sibling_err'),
               names_to='method',
               values_to='RMSE') %>%
  mutate(method = recode(method,
                         network_err='Network', 
                         sibling_err='Sibling'))

barplot_q_rmse_df <- 
    for_pr_plot %>%
    filter(loss == 'RMSE', str_detect(geo_name, 'City-level'), qty==recode_qty['prob']) %>%
  select(comparison_name, geo_name, qty, loss, network_err, sibling_err) %>%
  pivot_longer(cols=c('network_err', 'sibling_err'),
               names_to='method',
               values_to='RMSE') %>%
  mutate(method = recode(method,
                         network_err='Network', 
                         sibling_err='Sibling'))

barplot_asdr_rmse <- barplot_asdr_rmse_df %>%
  ggplot(.) +
  geom_bar(aes(x=method, y=RMSE), stat='identity') +
  theme_minimal() +
  xlab("") +
  ylab("Root Mean Squared Error")

saveRDS(barplot_asdr_rmse, file.path(out_dir, "rmse_barplot.rds"))
fec.size <- 3
ggsave(filename=file.path(out_dir, "rmse_barplot.pdf"),
       plot=barplot_asdr_rmse,
       height=fec.size,
       width=fec.size)
ggsave(filename=file.path(out_dir, "rmse_barplot.png"),
       plot=barplot_asdr_rmse,
       height=fec.size,
       width=fec.size)

net_rmse_tot <- barplot_asdr_rmse_df %>% filter(method=='Network') %>% pull(RMSE)
sib_rmse_tot <- barplot_asdr_rmse_df %>% filter(method=='Sibling') %>% pull(RMSE)

net_q_tot <- barplot_q_rmse_df %>% filter(method=='Network') %>% pull(RMSE)
sib_q_tot <- barplot_q_rmse_df %>% filter(method=='Sibling') %>% pull(RMSE)

glue::glue("
           Sibling ASDR RMSE is {round(100 * (sib_rmse_tot - net_rmse_tot)/net_rmse_tot,3)} percent higher than network RMSE
           Network ASDR RMSE is {round(100*  (net_rmse_tot - sib_rmse_tot)/sib_rmse_tot,3)} percent lower than sibling RMSE
           
           Sibling 47q18 RMSE is {round(100 * (sib_q_tot - net_q_tot)/net_q_tot,3)} percent higher than network RMSE
           Network 47q18 RMSE is {round(100*  (net_q_tot - sib_q_tot)/sib_q_tot,3)} percent lower than sibling RMSE
           
           ")
```


20250501 - CI for the 15% figure

QUICK SUMMARY: I think if you look at the plot, that's basically what we see here
The ASDR RMSE shows that network estimates are about 15% more accurate, but the CI includes 0
The 47q18 RMSE - which is more aggregated - shows that network estimates are about 


```{r}
for_pr_plot %>%
  filter(loss == 'RMSE',
         geo_name == 'City-level\nestimates',
         qty == 'Age-specifc\ndeath rates') %>% glimpse()

```

```{r}

```


## VR sensitivity version of figure above

```{r}
vrsens_err_compare <- make_pr_plot(for_pr_vrsens_plot)
  
saveRDS(vrsens_err_compare, file.path(out_dir, "err_compare_all_vrsens.rds"))
fec.size <- 8 
ggsave(filename=file.path(out_dir, "err_compare_all_vrsens.pdf"),
       plot=vrsens_err_compare,
       height=fec.size,
       width=fec.size)
ggsave(filename=file.path(out_dir, "err_compare_all_vrsens.png"),
       plot=vrsens_err_compare,
       height=fec.size,
       width=fec.size)

vrsens_err_compare
```



### Bias-variance decomposition (BVD) plot

```{r}
p_bvd_as_bias <- readRDS(file.path(vr_city_dir, 'bvd_as_bias_plot.rds'))

p_bvd_as_se <- readRDS(file.path(vr_city_dir, 'bvd_as_se_plot.rds'))

p_bvd_as_rmse <- readRDS(file.path(vr_city_dir, 'bvd_as_rmse_plot.rds'))
```


```{r}
#bvd_as_city <- p_bvd_as_rmse / p_bvd_as_bias / p_bvd_as_se + 
bvd_as_city <- 
  (p_bvd_as_se + ggtitle("A")) +
  (p_bvd_as_bias + ggtitle("B")) +
  (p_bvd_as_rmse + ggtitle("C")) +
  plot_layout(guides='collect') &
  #theme(text = element_text(size=7)) &
  theme(text = element_text(size=7),
        legend.position='bottom',
        legend.box='vertical',
        legend.spacing.y=unit(-.3, 'cm')) & 
  #guides(color=guide_legend(nrow=2, title="Age"))
  guides(color=guide_legend(title="Age"))

ggsave(filename=file.path(out_dir, "bvd_as_city.pdf"),
       bvd_as_city)

bvd_as_city
```

```{r}
#bvd_as_city <- p_bvd_as_rmse / p_bvd_as_bias / p_bvd_as_se + 
vd_as_city <- 
  (p_bvd_as_se + ggtitle("A")) +
  (p_bvd_as_bias + ggtitle("B")) +
  plot_layout(guides='collect') &
  #theme(text = element_text(size=7)) &
  theme(text = element_text(size=7),
        legend.position='bottom',
        legend.box='vertical',
        legend.spacing.y=unit(-.3, 'cm')) & 
  #guides(color=guide_legend(nrow=2, title="Age"))
  guides(color=guide_legend(title="Age"))

ggsave(filename=file.path(out_dir, "vd_as_city.pdf"),
       height=6,
       vd_as_city)

vd_as_city
```
